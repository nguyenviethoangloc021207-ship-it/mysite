<script>

// ƒê·ª£i trang load xong
document.addEventListener('DOMContentLoaded', function() {
  
  // Qu·∫£n l√Ω gi·ªè h√†ng
  class ShoppingCart {
    constructor() {
      this.items = this.loadCart();
      this.init();
    }

    // Load gi·ªè h√†ng t·ª´ localStorage
    loadCart() {
      try {
        const saved = localStorage.getItem('shoppingCart');
        return saved ? JSON.parse(saved) : [];
      } catch (e) {
        console.error('L·ªói load cart:', e);
        return [];
      }
    }

    // L∆∞u gi·ªè h√†ng v√†o localStorage
    saveCart() {
      try {
        localStorage.setItem('shoppingCart', JSON.stringify(this.items));
        this.updateCartCount();
        console.log('Cart saved:', this.items);
      } catch (e) {
        console.error('L·ªói save cart:', e);
      }
    }

    // Th√™m s·∫£n ph·∫©m v√†o gi·ªè
    addItem(id, name, price, image) {
      console.log('Adding item:', {id, name, price, image});
      
      const existingItem = this.items.find(item => item.id === id);
      
      if (existingItem) {
        existingItem.quantity += 1;
      } else {
        this.items.push({
          id: id,
          name: name,
          price: parseInt(price),
          image: image || '/images/placeholder.jpg',
          quantity: 1
        });
      }
      
      this.saveCart();
      this.showNotification(`‚úì ƒê√£ th√™m "${name}" v√†o gi·ªè h√†ng`);
    }

    // X√≥a s·∫£n ph·∫©m kh·ªèi gi·ªè
    removeItem(id) {
      this.items = this.items.filter(item => item.id !== id);
      this.saveCart();
      this.renderCart();
      this.showNotification('ƒê√£ x√≥a s·∫£n ph·∫©m');
    }

    // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng
    updateQuantity(id, quantity) {
      const item = this.items.find(item => item.id === id);
      if (item) {
        item.quantity = parseInt(quantity);
        if (item.quantity <= 0) {
          this.removeItem(id);
        } else {
          this.saveCart();
          this.renderCart();
        }
      }
    }

    // T√≠nh t·ªïng ti·ªÅn
    getTotal() {
      return this.items.reduce((total, item) => total + (item.price * item.quantity), 0);
    }

    // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng s·∫£n ph·∫©m tr√™n icon gi·ªè h√†ng
    updateCartCount() {
      const totalItems = this.items.reduce((sum, item) => sum + item.quantity, 0);
      const countElements = document.querySelectorAll('#cart-count, .cart-count');
      countElements.forEach(el => {
        el.textContent = totalItems;
        if (totalItems > 0) {
          el.style.display = 'inline-block';
        } else {
          el.style.display = 'none';
        }
      });
      console.log('Cart count updated:', totalItems);
    }

    // Hi·ªÉn th·ªã th√¥ng b√°o
    showNotification(message) {
      // X√≥a notification c≈© n·∫øu c√≥
      const oldNotif = document.querySelector('.cart-notification');
      if (oldNotif) oldNotif.remove();
      
      const notification = document.createElement('div');
      notification.className = 'cart-notification';
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.classList.add('show');
      }, 100);
      
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
      }, 2500);
    }

    // Render gi·ªè h√†ng
    renderCart() {
      const cartItemsContainer = document.getElementById('cart-items');
      const cartTotalElement = document.getElementById('cart-total');
      
      if (!cartItemsContainer) {
        console.log('Cart container not found');
        return;
      }

      if (this.items.length === 0) {
        cartItemsContainer.innerHTML = '<div class="empty-cart"><p>üõí Gi·ªè h√†ng tr·ªëng</p><p><a href="/products/">Xem s·∫£n ph·∫©m</a></p></div>';
        if (cartTotalElement) cartTotalElement.textContent = '0';
        return;
      }

      cartItemsContainer.innerHTML = this.items.map(item => `
        <div class="cart-item" data-id="${item.id}">
          <img src="${item.image}" alt="${item.name}" onerror="this.src='/images/placeholder.jpg'">
          <div class="cart-item-info">
            <h3>${item.name}</h3>
            <p class="item-price">${item.price.toLocaleString('vi-VN')} VNƒê</p>
          </div>
          <div class="cart-item-controls">
            <button class="quantity-btn minus-btn" data-id="${item.id}">-</button>
            <input type="number" class="quantity-input" value="${item.quantity}" min="1" data-id="${item.id}">
            <button class="quantity-btn plus-btn" data-id="${item.id}">+</button>
          </div>
          <div class="cart-item-total">
            ${(item.price * item.quantity).toLocaleString('vi-VN')} VNƒê
          </div>
          <button class="remove-btn" data-id="${item.id}">üóëÔ∏è</button>
        </div>
      `).join('');

      if (cartTotalElement) {
        cartTotalElement.textContent = this.getTotal().toLocaleString('vi-VN');
      }

      // Add event listeners cho c√°c n√∫t trong cart
      this.attachCartEventListeners();
    }

    // G·∫Øn event listeners cho c√°c n√∫t trong cart
    attachCartEventListeners() {
      // N√∫t gi·∫£m s·ªë l∆∞·ª£ng
      document.querySelectorAll('.minus-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = e.target.dataset.id;
          const item = this.items.find(i => i.id === id);
          if (item) {
            this.updateQuantity(id, item.quantity - 1);
          }
        });
      });

      // N√∫t tƒÉng s·ªë l∆∞·ª£ng
      document.querySelectorAll('.plus-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = e.target.dataset.id;
          const item = this.items.find(i => i.id === id);
          if (item) {
            this.updateQuantity(id, item.quantity + 1);
          }
        });
      });

      // Input s·ªë l∆∞·ª£ng
      document.querySelectorAll('.quantity-input').forEach(input => {
        input.addEventListener('change', (e) => {
          const id = e.target.dataset.id;
          const quantity = parseInt(e.target.value) || 1;
          this.updateQuantity(id, quantity);
        });
      });

      // N√∫t x√≥a
      document.querySelectorAll('.remove-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = e.target.dataset.id;
          if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m n√†y?')) {
            this.removeItem(id);
          }
        });
      });
    }

    // Thanh to√°n (gi·∫£)
    checkout() {
      if (this.items.length === 0) {
        alert('Gi·ªè h√†ng tr·ªëng!');
        return;
      }

      const total = this.getTotal();
      const itemsList = this.items.map(item => 
        `‚Ä¢ ${item.name} x${item.quantity} = ${(item.price * item.quantity).toLocaleString('vi-VN')} VNƒê`
      ).join('\n');

      if (confirm(`üõí X√ÅC NH·∫¨N THANH TO√ÅN\n\n${itemsList}\n\nüí∞ T·ªïng c·ªông: ${total.toLocaleString('vi-VN')} VNƒê\n\n(ƒê√¢y l√† giao d·ªãch gi·∫£ - kh√¥ng m·∫•t ti·ªÅn th·∫≠t)`)) {
        alert('‚úÖ Thanh to√°n th√†nh c√¥ng!\n\nC·∫£m ∆°n b·∫°n ƒë√£ mua h√†ng!\n(ƒê√¢y l√† demo - kh√¥ng c√≥ giao d·ªãch th·∫≠t)');
        this.items = [];
        this.saveCart();
        this.renderCart();
      }
    }

    // T√¨m ki·∫øm s·∫£n ph·∫©m
    searchProducts(query) {
      const products = document.querySelectorAll('.product-card');
      const searchTerm = query.toLowerCase().trim();

      products.forEach(product => {
        const name = (product.dataset.name || '').toLowerCase();
        if (name.includes(searchTerm) || searchTerm === '') {
          product.style.display = 'block';
        } else {
          product.style.display = 'none';
        }
      });
    }

    // Kh·ªüi t·∫°o event listeners
    init() {
      console.log('Cart initialized');
      this.updateCartCount();

      // Event listener cho n√∫t "Th√™m v√†o gi·ªè" - d√πng event delegation
      document.addEventListener('click', (e) => {
        const target = e.target;
        
        if (target.classList.contains('add-to-cart') || 
            target.classList.contains('add-to-cart-detail') ||
            target.closest('.add-to-cart') ||
            target.closest('.add-to-cart-detail')) {
          
          e.preventDefault();
          
          const btn = target.classList.contains('add-to-cart') || 
                      target.classList.contains('add-to-cart-detail') 
                      ? target 
                      : target.closest('.add-to-cart, .add-to-cart-detail');
          
          const id = btn.dataset.id || btn.getAttribute('data-id');
          const name = btn.dataset.name || btn.getAttribute('data-name');
          const price = btn.dataset.price || btn.getAttribute('data-price');
          const image = btn.dataset.image || btn.getAttribute('data-image');
          
          console.log('Button clicked:', {id, name, price, image});
          
          if (id && name && price) {
            this.addItem(id, name, price, image);
          } else {
            console.error('Missing data attributes:', {id, name, price, image});
          }
        }
      });

      // Event listener cho n√∫t thanh to√°n
      const checkoutBtn = document.getElementById('checkout-btn');
      if (checkoutBtn) {
        checkoutBtn.addEventListener('click', () => this.checkout());
      }

      // Render gi·ªè h√†ng n·∫øu ƒëang ·ªü trang gi·ªè h√†ng
      if (document.getElementById('cart-items')) {
        console.log('Rendering cart page');
        this.renderCart();
      }

      // T√¨m ki·∫øm s·∫£n ph·∫©m
      const searchInput = document.getElementById('search-input');
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          this.searchProducts(e.target.value);
        });
      }
    }
  }

  // Kh·ªüi t·∫°o gi·ªè h√†ng
  window.cart = new ShoppingCart();
  console.log('Shopping cart ready!');
});

</script>